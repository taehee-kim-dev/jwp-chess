<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
        crossorigin="anonymous">
  <title>인비의 체스게임</title>
</head>
<style>
    .cell {
        height: 50px;
        padding: 0px;
        border: 1px solid black;
    }
    .cell:hover {
        filter: brightness(85%);
        cursor: pointer;
    }
    .row {
        width: 400px;
        margin-left: auto;
        margin-right: auto;
    }
    .status {
        height: 50px;
    }
    .content {
        display: table-cell;
        vertical-align: middle;
    }
    #current-turn-team-name {
        margin-bottom: 28px;
    }
    #exit_button {
        width: 400px;
        margin-top: 22px;
    }
</style>
<body>

<h1 style="text-align: center; margin-top: 36px;margin-bottom: 27px;" th:text="${gameStatusDto.getTitle()}"></h1>

<div id="chess-board" style="text-align: center; width: 720px; margin-left: auto; margin-right: auto">

  <div id="current-status">
    <div id="current-scores" style="display: flex">
      <div class="score status content" style="flex: 1" th:text="'백 팀 : ' + ${gameStatusDto.getWhitePlayerScore()} + '점'"></div>
      <div class="score status content" style="flex: 1" th:text="'흑 팀 : ' + ${gameStatusDto.getBlackPlayerScore()} + '점'"></div>
    </div>
    <div id="current-turn-team-name" th:text="'현재 차례 : ' + ${gameStatusDto.getCurrentTurnTeamColorName()} + ' 팀'"></div>
  </div>

  <div>
    <div style="display: flex" class="row">
      <div id="a8" style="flex: 1; background-color: white" class="cell"></div>
      <div id="b8" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="c8" style="flex: 1; background-color: white" class="cell"></div>
      <div id="d8" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="e8" style="flex: 1; background-color: white" class="cell"></div>
      <div id="f8" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="g8" style="flex: 1; background-color: white" class="cell"></div>
      <div id="h8" style="flex: 1; background-color: darkgray" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a7" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="b7" style="flex: 1; background-color: white" class="cell"></div>
      <div id="c7" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="d7" style="flex: 1; background-color: white" class="cell"></div>
      <div id="e7" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="f7" style="flex: 1; background-color: white" class="cell"></div>
      <div id="g7" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="h7" style="flex: 1; background-color: white" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a6" style="flex: 1; background-color: white" class="cell"></div>
      <div id="b6" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="c6" style="flex: 1; background-color: white" class="cell"></div>
      <div id="d6" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="e6" style="flex: 1; background-color: white" class="cell"></div>
      <div id="f6" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="g6" style="flex: 1; background-color: white" class="cell"></div>
      <div id="h6" style="flex: 1; background-color: darkgray" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a5" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="b5" style="flex: 1; background-color: white" class="cell"></div>
      <div id="c5" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="d5" style="flex: 1; background-color: white" class="cell"></div>
      <div id="e5" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="f5" style="flex: 1; background-color: white" class="cell"></div>
      <div id="g5" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="h5" style="flex: 1; background-color: white" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a4" style="flex: 1; background-color: white" class="cell"></div>
      <div id="b4" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="c4" style="flex: 1; background-color: white" class="cell"></div>
      <div id="d4" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="e4" style="flex: 1; background-color: white" class="cell"></div>
      <div id="f4" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="g4" style="flex: 1; background-color: white" class="cell"></div>
      <div id="h4" style="flex: 1; background-color: darkgray" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a3" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="b3" style="flex: 1; background-color: white" class="cell"></div>
      <div id="c3" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="d3" style="flex: 1; background-color: white" class="cell"></div>
      <div id="e3" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="f3" style="flex: 1; background-color: white" class="cell"></div>
      <div id="g3" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="h3" style="flex: 1; background-color: white" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a2" style="flex: 1; background-color: white" class="cell"></div>
      <div id="b2" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="c2" style="flex: 1; background-color: white" class="cell"></div>
      <div id="d2" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="e2" style="flex: 1; background-color: white" class="cell"></div>
      <div id="f2" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="g2" style="flex: 1; background-color: white" class="cell"></div>
      <div id="h2" style="flex: 1; background-color: darkgray" class="cell"></div>
    </div>
    <div style="display: flex" class="row">
      <div id="a1" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="b1" style="flex: 1; background-color: white" class="cell"></div>
      <div id="c1" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="d1" style="flex: 1; background-color: white" class="cell"></div>
      <div id="e1" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="f1" style="flex: 1; background-color: white" class="cell"></div>
      <div id="g1" style="flex: 1; background-color: darkgray" class="cell"></div>
      <div id="h1" style="flex: 1; background-color: white" class="cell"></div>
    </div>
  </div>

  <div style="text-align: center">
    <button id="exit_button" class="btn btn-outline-danger" onclick="exitConfirm();">게임 나가기</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script>
<script type="text/javascript">
  const board_status = getCookieByValue('boardStatus');

  const ranks = ['8', '7', '6', '5', '4', '3', '2', '1'];
  const files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];

  const positions = [];

  for (const rank of ranks) {
    for (const file of files) {
      positions.push(file + rank);
    }
  }

  let is_start_position_clicked = false;
  let start_position = null;
  let destination = null;

  const all_cells_size = 64;
  for (let i = 0; i < all_cells_size; i++) {
    const img = document.createElement('img');
    img.addEventListener('click', (event) => {
      if (!is_start_position_clicked) {
        start_position = event.target.parentElement.id;
        is_start_position_clicked = true;
        return;
      }
      destination = event.target.parentElement.id;
      request_move_post();
    });
    img.style.width = '100%';
    img.style.height = '100%';
    if (board_status.charAt(i) === 'P') {
      img.src = '/images/black-pawn.png';
    }
    if (board_status.charAt(i) === 'R') {
      img.src = '/images/black-rook.png';
    }
    if (board_status.charAt(i) === 'N') {
      img.src = '/images/black-knight.png';
    }
    if (board_status.charAt(i) === 'B') {
      img.src = '/images/black-bishop.png';
    }
    if (board_status.charAt(i) === 'Q') {
      img.src = '/images/black-queen.png';
    }
    if (board_status.charAt(i) === 'K') {
      img.src = '/images/black-king.png';
    }

    if (board_status.charAt(i) === 'p') {
      img.src = '/images/white-pawn.png';
    }
    if (board_status.charAt(i) === 'r') {
      img.src = '/images/white-rook.png';
    }
    if (board_status.charAt(i) === 'n') {
      img.src = '/images/white-knight.png';
    }
    if (board_status.charAt(i) === 'b') {
      img.src = '/images/white-bishop.png';
    }
    if (board_status.charAt(i) === 'q') {
      img.src = '/images/white-queen.png';
    }
    if (board_status.charAt(i) === 'k') {
      img.src = '/images/white-king.png';
    }
    const cell = document.getElementById(positions[i]);
    cell.appendChild(img);
  }

  const game_id = getCookieByValue('gameId');

  function request_move_post() {
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '/move', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'json';
    xhr.send(JSON.stringify({
      gameId: game_id,
      startPositionInput: start_position,
      destinationInput: destination
    }));
    start_position = null;
    destination = null;
    is_start_position_clicked = false;
    xhr.onload = function () {
      const move_response = xhr.response;
      if (move_response['canMove'] === false) {
        alert(move_response['errorMessage']);
        return;
      }
      window.location.href = '/games/' + game_id;
    };
  }

  if (getCookieByValue('isKingDead') === "true") {
    alert(getCookieByValue('beforeTurnTeamColorName') + ' 팀이 이겼습니다.');
    exitAndDeleteGame();
  }

  function exitAndDeleteGame() {
    const xhr = new XMLHttpRequest();
    xhr.open('DELETE', '/games/' + game_id, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.responseType = 'json';
    xhr.send();
    xhr.onload = function () {
      const delete_response = xhr.response;
      if (delete_response === 'OK') {
        window.location.href = '/';
      }
    };
  }

  function exitConfirm() {
    const is_exit = confirm('게임을 나가면 이 게임은 삭제됩니다. 정말 나가시겠습니까?');
    if (!is_exit) {
      return false;
    }
    exitAndDeleteGame();
  }

  function getCookieByValue(value) {
    const name = value + "=";
    const ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) === 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
  }
</script>
</body>
</html>